<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <meta name="theme-color" content="#495057">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>HTMLÁ®ãÂºèÁ¢ºÊ≤ôÁõí</title>
  <style>
    :root {
      --color-main: #495057;
      --color-gray: #adb5bd;
      --color-light: #e9ecef;
      --color-bg: #f5f5f5;
      --color-white: #fff;
      --color-gold: #ffc107;
      --radius: 6px;
      --gap: 8px;
      --btn-h: 36px;
      --trans: 0.2s ease;
    }
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    html, body { 
      width: 100%; 
      height: 100%; 
    }
    body {
      background: var(--color-bg);
      font-family: -apple-system, "Segoe UI", "Microsoft JhengHei", sans-serif;
      color: var(--color-main);
      font-size: 14px;
    }
    .app-header {
      display: flex;
      align-items: center;
      background: var(--color-white);
      border-bottom: 1px solid var(--color-light);
      padding: 0 var(--gap);
      height: 52px;
      gap: var(--gap);
      flex-shrink: 0;
    }
    .app-logo {
      font-size: 1.6rem;
      font-weight: 700;
      letter-spacing: 1.5px;
      color: var(--color-main);
      animation: bounce 1s infinite alternate;
    }
    @keyframes bounce {
      0% { transform: translateY(0); }
      100% { transform: translateY(-4px); }
    }
    .tab-bar {
      display: flex;
      gap: var(--gap);
      flex: 1;
      margin-left: var(--gap);
    }
    .tab-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: var(--btn-h);
      min-width: 90px;
      font-size: 13px;
      border: none;
      border-radius: var(--radius);
      background: var(--color-light);
      color: var(--color-main);
      font-weight: 500;
      cursor: pointer;
      transition: background var(--trans);
      padding: 0 12px;
    }
    .tab-btn:active {
      transform: scale(0.98);
    }
    .tab-btn.active {
      background: var(--color-gray);
      color: var(--color-white);
    }
    .main-area {
      width: 100vw;
      height: calc(100vh - 52px);
      display: flex;
      flex-direction: column;
      background: var(--color-bg);
      position: relative;
      overflow: hidden;
    }
    .panel {
      display: none;
      flex-direction: column;
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }
    .panel.active {
      display: flex;
    }
    .func-bar {
      background: var(--color-gray);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 var(--gap);
      height: 44px;
      border-radius: var(--radius) var(--radius) 0 0;
      gap: var(--gap);
      flex-shrink: 0;
    }
    .func-btn-group {
      display: flex;
      gap: var(--gap);
      align-items: center;
    }
    .func-btn {
      background: var(--color-light);
      color: var(--color-main);
      border: none;
      border-radius: var(--radius);
      font-size: 12px;
      font-weight: 500;
      height: 32px;
      min-width: 50px;
      padding: 0 10px;
      cursor: pointer;
      transition: background var(--trans);
      white-space: nowrap;
    }
    .func-btn:active { 
      background: var(--color-main);
      color: var(--color-white);
      transform: scale(0.98);
    }
    .pin-btn {
      width: 32px;
      height: 32px;
      padding: 0;
      border-radius: 50%;
      background: var(--color-light);
      border: 2px solid transparent;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--trans);
      margin-right: auto;
    }
    .pin-btn:active {
      transform: scale(0.95);
    }
    .pin-btn.active {
      background: var(--color-gold);
      color: var(--color-main);
      box-shadow: 0 2px 6px rgba(255, 193, 7, 0.4);
    }
    .content-area {
      background: var(--color-white);
      border-radius: 0 0 var(--radius) var(--radius);
      flex: 1;
      padding: var(--gap);
      overflow: auto;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    .preview-bar {
      background: var(--color-gray);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--gap);
      height: 44px;
      border-radius: var(--radius) var(--radius) 0 0;
      color: var(--color-white);
      font-weight: 500;
      font-size: 13px;
      flex-shrink: 0;
    }
    .history-bar {
      background: var(--color-gray);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--gap);
      height: 44px;
      border-radius: var(--radius) var(--radius) 0 0;
      color: var(--color-white);
      font-weight: 500;
      font-size: 13px;
      flex-shrink: 0;
    }
    textarea {
      width: 100%;
      flex: 1;
      border-radius: var(--radius);
      font-size: 13px;
      border: 1px solid #e0e0e0;
      padding: 10px;
      resize: none;
      font-family: 'Courier New', monospace;
      outline: none;
      transition: border-color var(--trans);
    }
    textarea:focus {
      border-color: var(--color-gray);
    }
    .history-list {
      list-style: none;
      padding: 0;
      margin: 0;
      flex: 1;
      overflow-y: auto;
    }
    .history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--color-light);
      transition: background var(--trans);
    }
    .history-item:hover {
      background: #f9f9f9;
    }
    .history-info {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 0;
      gap: 3px;
    }
    .history-title {
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .history-meta {
      color: #999;
      font-size: 11px;
    }
    .history-actions {
      display: flex;
      gap: var(--gap);
      align-items: center;
      flex-shrink: 0;
    }
    .iframe-preview {
      width: 100%;
      flex: 1;
      border: 1px solid #e0e0e0;
      border-radius: var(--radius);
    }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #ccc;
      font-size: 13px;
    }

    /* ========== Bottom Sheet Ê®£Âºè ========== */
    .bottom-sheet-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    .bottom-sheet-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .bottom-sheet {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #1a1a1a;
      z-index: 1000;
      width: 100%;
      height: 100%;
      max-height: 100vh;
      display: flex;
      flex-direction: column;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      touch-action: none;
    }

    .bottom-sheet.active {
      transform: translateY(0);
    }

    .bottom-sheet-handle {
      width: 40px;
      height: 4px;
      background: #444444;
      border-radius: 2px;
      margin: 12px auto;
      cursor: grab;
    }

    .bottom-sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px 16px;
      border-bottom: 1px solid #3a3a3a;
      flex-shrink: 0;
    }

    .bottom-sheet-title {
      color: #ffffff;
      font-size: 19px;
      font-weight: 600;
    }

    .bottom-sheet-close {
      font-size: 24px;
      cursor: pointer;
      color: #808080;
    }

    .bottom-sheet-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      padding: 16px;
      width: 100%;
      position: relative;
    }

    .bottom-sheet-content iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 10px;
    }

    /* Ê∫êÁ¢ºÂÖßÂÆπÊ®£Âºè */
    .source-code-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: #111;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .source-code-main {
      width: 100%;
      max-width: 420px;
      padding: 0 2vw;
      box-sizing: border-box;
      flex: 1;
      overflow-y: auto;
      margin: 0 auto;
      position: relative;
    }

    .source-code-main h1 {
      font-size: 1.3em;
      margin: 24px 0 12px 0;
      text-align: center;
    }

    .source-code-main .input-box {
      margin-top: 6px;
    }

    .source-code-main .input-field {
      width: 100%;
      padding: 11px;
      border-radius: 8px;
      border: none;
      font-size: 1em;
      background: #222;
      color: #fff;
      box-sizing: border-box;
    }

    .source-code-main .btn-group {
      display: flex;
      gap: 8px;
      margin-top: 13px;
    }

    .source-code-main .btn-primary {
      flex: 1;
      display: block;
      background: #0792ff;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: bold;
      font-size: 1.1em;
      line-height: 42px;
      transition: filter .13s;
      cursor: pointer;
    }

    .source-code-main .btn-primary:active {
      filter: brightness(0.9);
    }

    .source-code-main .btn-secondary {
      flex: 1;
      display: block;
      background: #444;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: bold;
      font-size: 1.1em;
      line-height: 42px;
      transition: filter .13s;
      cursor: pointer;
    }

    .source-code-main .btn-secondary:active {
      filter: brightness(0.8);
    }

    .source-code-main .section-title {
      font-size: 1em;
      margin: 22px 0 3px 0;
      display: flex;
      align-items: center;
    }

    .source-code-main .ico-btn {
      background: none;
      border: none;
      padding: 0;
      margin-left: 6px;
      cursor: pointer;
    }

    .source-code-main .ico-btn:active svg {
      filter: brightness(.7);
    }

    .source-code-main .result-box {
      min-height: 150px;
      background: #191919;
      border-radius: 9px;
      color: #f8f8f8;
      padding: 12px;
      font-size: 0.98em;
      word-break: break-all;
      overflow: auto;
      box-sizing: border-box;
    }

    .source-code-main .copied-tip {
      position: absolute;
      right: 9vw;
      top: 6px;
      font-size: 0.92em;
      padding: 3px 12px;
      background: #222;
      border-radius: 4px;
      color: #4ec993;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s;
    }

    .source-code-main .copied-tip.show {
      opacity: 0.97;
    }

    /* ========== Ë§áË£ΩÂèçÈ•ãÊèêÁ§∫ ========== */
    .copy-feedback {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #222;
      color: #4ec993;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 10001;
      pointer-events: none;
      animation: fadeInOut 1.5s ease-in-out;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      10% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      90% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
    }
  </style>
</head>
<body>
  <div class="app-header">
    <span class="app-logo">HTML</span>
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="0">Á∑®ËºØ</button>
      <button class="tab-btn" data-tab="1">È†êË¶Ω</button>
      <button class="tab-btn" data-tab="2">Á¥ÄÈåÑ</button>
    </div>
  </div>
  
  <div class="main-area" id="mainArea">
    <!-- Á∑®ËºØÈ†Å -->
    <div class="panel active" id="panel-0">
      <div class="func-bar">
        <button class="pin-btn" id="pinBtn">üìç</button>
        <div class="func-btn-group">
          <button class="func-btn" id="sourceCodeBtn">Ê∫êÁ¢º</button>
          <button class="func-btn" id="pasteBtn">Ë≤º‰∏ä</button>
          <button class="func-btn" id="copyBtn">Ë§áË£Ω</button>
          <button class="func-btn" id="clearBtn">Ê∏ÖÁ©∫</button>
          <button class="func-btn" id="runBtn">Âü∑Ë°å</button>
        </div>
      </div>
      <div class="content-area">
        <textarea id="codeInput" placeholder="Âú®Ê≠§Ë≤º‰∏äHTML..."></textarea>
      </div>
    </div>

    <!-- È†êË¶ΩÈ†Å -->
    <div class="panel" id="panel-1">
      <div class="preview-bar">
        <span>Âç≥ÊôÇÈ†êË¶Ω</span>
        <button class="func-btn" id="refreshBtn">Âà∑Êñ∞</button>
      </div>
      <div class="content-area">
        <iframe id="previewFrame" class="iframe-preview" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-presentation"></iframe>
      </div>
    </div>

    <!-- Ê≠∑Âè≤È†Å -->
    <div class="panel" id="panel-2">
      <div class="history-bar">
        <span>Ê≠∑Âè≤Á¥ÄÈåÑ</span>
        <button class="func-btn" id="clearAllHistoryBtn">Ê∏ÖÁ©∫</button>
      </div>
      <div class="content-area">
        <ul class="history-list" id="historyList"></ul>
      </div>
    </div>
  </div>

  <!-- Bottom Sheet ÂÆπÂô® -->
  <div class="bottom-sheet-overlay" id="bottomSheetOverlay" onclick="closeBottomSheet()"></div>
  <div class="bottom-sheet" id="bottomSheet">
    <div class="bottom-sheet-handle"></div>
    <div class="bottom-sheet-header">
      <div class="bottom-sheet-title" id="sheetTitle">Â∑•ÂÖ∑</div>
      <div class="bottom-sheet-close" onclick="closeBottomSheet()">‚úï</div>
    </div>
    <div class="bottom-sheet-content" id="sheetContent"></div>
  </div>

  <script>
    // ========== DOM ÂÖÉÁ¥† ==========
    const codeInput = document.getElementById('codeInput');
    const previewFrame = document.getElementById('previewFrame');
    const pinBtn = document.getElementById('pinBtn');
    const mainArea = document.getElementById('mainArea');
    const historyList = document.getElementById('historyList');
    const sourceCodeBtn = document.getElementById('sourceCodeBtn');

    let currentTab = 0;
    let isPinned = false;
    let touchStartX = 0;

    // ========== Bottom Sheet ÂÖ®Â±ÄËÆäÊï∏ ============
    let sheetStartY = 0;
    let sheetCurrentY = 0;

    // ========== Bottom Sheet Ê†∏ÂøÉÂáΩÊï∏ ============
    function openBottomSheet(title, content) {
      document.getElementById('sheetTitle').textContent = title;
      document.getElementById('sheetContent').innerHTML = content;
      document.getElementById('bottomSheet').classList.add('active');
      document.getElementById('bottomSheetOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeBottomSheet() {
      document.getElementById('bottomSheet').classList.remove('active');
      document.getElementById('bottomSheetOverlay').classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    function setupBottomSheetGestures() {
      const sheet = document.getElementById('bottomSheet');
      const handle = document.querySelector('.bottom-sheet-handle');
      
      if (!handle) return;

      handle.addEventListener('touchstart', (e) => {
        sheetStartY = e.touches[0].clientY;
      });

      handle.addEventListener('touchmove', (e) => {
        sheetCurrentY = e.touches[0].clientY - sheetStartY;
        if (sheetCurrentY > 0) {
          sheet.style.transform = `translateY(${sheetCurrentY}px)`;
        }
      });

      handle.addEventListener('touchend', () => {
        if (sheetCurrentY > 100) {
          closeBottomSheet();
        } else {
          sheet.style.transform = 'translateY(0)';
        }
        sheetStartY = 0;
        sheetCurrentY = 0;
      });
    }

    // ========== Ë§áË£ΩÂèçÈ•ãÂáΩÊï∏ ==========
    function showCopyFeedback(message, targetElement = null) {
      const feedback = document.createElement('div');
      feedback.className = 'copy-feedback';
      feedback.textContent = message;
      
      if (targetElement) {
        targetElement.appendChild(feedback);
      } else {
        document.body.appendChild(feedback);
      }
      
      setTimeout(() => {
        feedback.remove();
      }, 1500);
    }

    // ========== Ê∫êÁ¢ºÂäüËÉΩ ==========
    sourceCodeBtn.onclick = function() {
      const sourceCodeContent = `
        <div class="source-code-container">
          <div class="source-code-main">
            <h1>Êü•ÁúãÁ∂≤È†ÅÂéüÂßãÁ¢º</h1>
            <div class="input-box">
              <input id="sourceUrlInput" class="input-field" placeholder="Ë´ãËº∏ÂÖ•ÈúÄË¶ÅÊ™¢Ë¶ñÁöÑÁ∂≤È†ÅÈÄ£Áµê..." autocomplete="off" spellcheck="false" oninput="localSaveUrl(this.value)">
              <div class="btn-group">
                <button class="btn-primary" id="sourceFetchBtn" onclick="sourceCodeFetchSourceCode()">Êèê‰∫§</button>
                <button class="btn-secondary" onclick="sourceCodePasteUrl()">Ë≤º‰∏ä</button>
                <button class="btn-secondary" onclick="sourceCodeClearUrl()">Ê∏ÖÈô§</button>
              </div>
            </div>
            <div class="section-title" style="margin-top:18px;">
              ÁµêÊûú
              <button class="ico-btn" title="Ë§áË£Ω" id="sourceCopyBtn" onclick="sourceCodeCopyResult()">
                <svg height="21" viewBox="0 0 20 20" width="21" xmlns="http://www.w3.org/2000/svg"><path fill="#58a2fd" d="M8 4V1H3a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h2v-2H3V3h5zm3-3v2h4.01v14H11v2h4.01A1.99 1.99 0 0 0 17 17V3c0-1.1-.89-2-1.99-2H11zm-1 4H7c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h4c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 12H7V7h4v10z"/>
                </svg>
              </button>
              <span class="copied-tip" id="sourceCopiedTip">Â∑≤Ë§áË£ΩÔºÅ</span>
            </div>
            <div class="result-box" id="sourceResult" tabindex="0"></div>
          </div>
        </div>
      `;
      openBottomSheet('Êü•ÁúãÁ∂≤È†ÅÂéüÂßãÁ¢º', sourceCodeContent);
      
      // ËºâÂÖ•ÂÑ≤Â≠òÁöÑÁ∂≤ÂùÄ
      setTimeout(() => {
        const savedUrl = localStorage.getItem("last_url") || "";
        const urlInput = document.getElementById('sourceUrlInput');
        if (urlInput && savedUrl) {
          urlInput.value = savedUrl;
        }
      }, 100);
    };

    // Ê∫êÁ¢ºÂäüËÉΩÁõ∏ÈóúÂáΩÊï∏
    window.localSaveUrl = function(url) {
      localStorage.setItem("last_url", url);
    };

    window.sourceCodeFetchSourceCode = function() {
      const url = document.getElementById('sourceUrlInput').value.trim();
      const resBox = document.getElementById('sourceResult');
      resBox.textContent = '';
      if(!url.match(/^https?:\/\//)) {
        resBox.textContent = 'Ë´ãËº∏ÂÖ•ÂêàÊ≥ï http(s) Á∂≤ÂùÄ„ÄÇ';
        return;
      }
      resBox.textContent = 'ËºâÂÖ•‰∏≠...';
      fetch(url)
        .then(resp => resp.text())
        .then(html => {
          resBox.textContent = html || 'ÔºàÊ≤íÊúâÂÖßÂÆπÔºâ';
          localSaveUrl(url);
        })
        .catch(e=>{
          resBox.textContent = 'ÂèñÂæóÂ§±ÊïóÔºöÁÑ°Ê≥ïÂ≠òÂèñÁ∂≤ÂùÄÊàñË∑®ÂüüÈôêÂà∂ ('+e+').';
        });
    };

    window.sourceCodePasteUrl = function() {
      navigator.clipboard.readText().then(text => {
        document.getElementById('sourceUrlInput').value = text.trim();
        localSaveUrl(text.trim());
      }).catch(e => {
        alert('ÁÑ°Ê≥ïËÆÄÂèñÂâ™Ë≤ºÁ∞øÔºö' + e);
      });
    };

    window.sourceCodeClearUrl = function() {
      document.getElementById('sourceUrlInput').value = '';
      localStorage.removeItem("last_url");
    };

    window.sourceCodeCopyResult = function() {
      const resBox = document.getElementById('sourceResult');
      if(!resBox.textContent) return;
      navigator.clipboard.writeText(resBox.textContent).then(()=>{
        const sourceCodeMain = document.querySelector('.source-code-main');
        if (sourceCodeMain) {
          showCopyFeedback('Â∑≤Ë§áË£ΩÔºÅ', sourceCodeMain);
        }
      }).catch(() => {
        const sourceCodeMain = document.querySelector('.source-code-main');
        if (sourceCodeMain) {
          showCopyFeedback('Ë§áË£ΩÂ§±Êïó', sourceCodeMain);
        }
      });
    };

    // ========== Tab ÈªûÊìäÂàáÊèõ ==========
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.onclick = function() {
        const tabIndex = parseInt(this.getAttribute('data-tab'));
        switchTab(tabIndex);
      };
    });

    function switchTab(tabIndex) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      
      document.querySelectorAll('.tab-btn')[tabIndex].classList.add('active');
      document.getElementById(`panel-${tabIndex}`).classList.add('active');
      
      currentTab = tabIndex;
      
      if (tabIndex === 1) {
        setTimeout(() => runCode(), 100);
      }
    }

    // ========== ÊªëÂãïÂàáÊèõ ==========
    mainArea.ontouchstart = function(e) {
      touchStartX = e.touches[0].clientX;
    };

    mainArea.ontouchend = function(e) {
      const touchEndX = e.changedTouches[0].clientX;
      const diff = touchStartX - touchEndX;
      if (Math.abs(diff) > 50) {
        if (diff > 0 && currentTab < 2) switchTab(currentTab + 1);
        if (diff < 0 && currentTab > 0) switchTab(currentTab - 1);
      }
    };

    // ========== Èáò‰ΩèÂäüËÉΩ ==========
    function updatePinBtn() {
      if (isPinned) {
        pinBtn.classList.add('active');
        pinBtn.title = 'ÂèñÊ∂àÈáò‰Ωè';
      } else {
        pinBtn.classList.remove('active');
        pinBtn.title = 'Èáò‰Ωè';
      }
    }

    pinBtn.onclick = function() {
      isPinned = !isPinned;
      updatePinBtn();
      if (isPinned) {
        localStorage.setItem('htmlSandbox_pinned', codeInput.value);
      } else {
        localStorage.removeItem('htmlSandbox_pinned');
      }
    };

    // ÂàùÂßãËºâÂÖ•Èáò‰Ωè‰ª£Á¢º
    const pinnedCode = localStorage.getItem('htmlSandbox_pinned');
    if (pinnedCode) {
      codeInput.value = pinnedCode;
      isPinned = true;
      updatePinBtn();
    }

    // ========== Âü∑Ë°å‰ª£Á¢º ==========
    function runCode() {
      const code = codeInput.value;
      previewFrame.srcdoc = code;
      if (isPinned) {
        localStorage.setItem('htmlSandbox_pinned', code);
      }
      addToHistory(code);
    }

    document.getElementById('runBtn').onclick = runCode;
    document.getElementById('refreshBtn').onclick = runCode;

    // ========== Ë≤º‰∏äÂäüËÉΩ ==========
    document.getElementById('pasteBtn').onclick = async function() {
      try {
        const text = await navigator.clipboard.readText();
        codeInput.value = text;
        switchTab(1);
        setTimeout(runCode, 100);
      } catch (e) {
        alert("Ââ™Ë≤ºÁ∞øÂ≠òÂèñÂ§±Êïó");
      }
    };

    // ========== Ë§áË£ΩÂäüËÉΩ ==========
    document.getElementById('copyBtn').onclick = async function() {
      try {
        await navigator.clipboard.writeText(codeInput.value);
        showCopyFeedback('Â∑≤Ë§áË£ΩÔºÅ');
      } catch (e) {
        showCopyFeedback('Ë§áË£ΩÂ§±Êïó');
      }
    };

    // ========== Ê∏ÖÁ©∫ÂäüËÉΩ ==========
    document.getElementById('clearBtn').onclick = function() {
      codeInput.value = '';
      previewFrame.srcdoc = '';
    };

    // ========== Ê≠∑Âè≤Á¥ÄÈåÑ ==========
    function extractTitle(html) {
      const match = html.match(/<title[^>]*>(.*?)<\/title>/i);
      if (match && match[1]) {
        return match[1].trim();
      }
      return `Á®ãÂºèÁ¢º_${new Date().toLocaleDateString('zh-TW')}`;
    }

    function addToHistory(code) {
      if (!code.trim()) return;
      let history = JSON.parse(localStorage.getItem('htmlSandbox_history') || '[]');
      const name = extractTitle(code);
      const time = new Date().toLocaleString('zh-TW');
      
      if (history.length && history[0].code === code) return;
      
      history.unshift({ name, code, time });
      while (history.length > 20) history.pop();
      
      localStorage.setItem('htmlSandbox_history', JSON.stringify(history));
      renderHistory();
    }

    function renderHistory() {
      const history = JSON.parse(localStorage.getItem('htmlSandbox_history') || '[]');
      
      if (!history.length) {
        historyList.innerHTML = '<div class="empty-state">Êö´ÁÑ°Á¥ÄÈåÑ</div>';
        return;
      }
      
      historyList.innerHTML = history.map((item, idx) => `
        <li class="history-item">
          <div class="history-info">
            <div class="history-title">${escapeHtml(item.name)}</div>
            <div class="history-meta">${item.time}</div>
          </div>
          <div class="history-actions">
            <button class="func-btn" onclick="loadHistoryItem(${idx})">‰ΩøÁî®</button>
            <button class="func-btn" onclick="deleteHistoryItem(${idx})">Âà™Èô§</button>
          </div>
        </li>
      `).join('');
    }

    window.loadHistoryItem = function(idx) {
      const history = JSON.parse(localStorage.getItem('htmlSandbox_history') || '[]');
      if (history[idx]) {
        codeInput.value = history[idx].code;
        switchTab(0);
      }
    };

    window.deleteHistoryItem = function(idx) {
      let history = JSON.parse(localStorage.getItem('htmlSandbox_history') || '[]');
      history.splice(idx, 1);
      localStorage.setItem('htmlSandbox_history', JSON.stringify(history));
      renderHistory();
    };

    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    document.getElementById('clearAllHistoryBtn').onclick = function() {
      if (confirm('Á¢∫ÂÆöÊ∏ÖÁ©∫ÊâÄÊúâÁ¥ÄÈåÑÔºü')) {
        localStorage.removeItem('htmlSandbox_history');
        renderHistory();
      }
    };

    // ÂàùÂßãËºâÂÖ•Ê≠∑Âè≤
    renderHistory();

    // ========== ÂàùÂßãÂåñ Bottom Sheet ============
    window.addEventListener('DOMContentLoaded', () => {
      setupBottomSheetGestures();
    });
  </script>
</body>
</html>
