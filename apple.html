<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="æ•´åˆå·¥å…·">
<title>æ•´åˆå·¥å…·</title>
<style>
/* CSS è¨­è¨ˆç³»çµ± */
:root {
  --color-bg-primary: #1a1a1a;
  --color-bg-secondary: #242424;
  --color-bg-tertiary: #2a2a2a;
  --color-bg-card: #2f2f2f;
  --color-border: #3a3a3a;
  --color-border-light: #444444;
  --color-text-primary: #ffffff;
  --color-text-secondary: #b0b0b0;
  --color-text-tertiary: #808080;
  
  --spacing-xs: 4px;
  --spacing-sm: 6px;
  --spacing-md: 10px;
  --spacing-lg: 12px;
  --spacing-xl: 16px;
  --spacing-2xl: 20px;
  
  --font-size-xs: 11px;
  --font-size-sm: 13px;
  --font-size-base: 15px;
  --font-size-md: 17px;
  --font-size-lg: 19px;
  
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 14px;
  --radius-xl: 16px;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
  background: var(--color-bg-primary);
  color: var(--color-text-secondary);
  font-size: var(--font-size-base);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  display: flex;
  flex-direction: column;
}

/* ========== é é¢å®¹å™¨ ========== */
.page-wrapper {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ========== é ­éƒ¨ ========== */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-lg);
  background: var(--color-bg-secondary);
  border-bottom: 1px solid var(--color-border);
  position: sticky;
  top: 0;
  z-index: 50;
  flex-shrink: 0;
}

.header-left {
  color: var(--color-text-primary);
  font-size: var(--font-size-md);
  font-weight: 500;
  cursor: pointer;
}

.header-center {
  color: var(--color-text-primary);
  font-size: var(--font-size-lg);
  font-weight: 600;
}

.header-right {
  color: var(--color-text-primary);
  font-size: var(--font-size-xl);
  cursor: pointer;
}

/* ========== æœç´¢æ¬„ ========== */
.search-container {
  padding: var(--spacing-lg);
  background: var(--color-bg-secondary);
  flex-shrink: 0;
}

.search-box {
  display: flex;
  align-items: center;
  background: var(--color-bg-tertiary);
  border-radius: var(--radius-lg);
  padding: var(--spacing-md) var(--spacing-lg);
  gap: var(--spacing-sm);
}

.search-input {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  color: var(--color-text-secondary);
  font-size: var(--font-size-base);
}

.search-input::placeholder {
  color: var(--color-text-tertiary);
}

/* ========== åˆ†é¡æ¨™ç±¤ï¼ˆè—è‰²å€åŸŸï¼‰ ========== */
.tabs-container {
  padding: var(--spacing-md) var(--spacing-lg);
  background: var(--color-bg-secondary);
  border-bottom: 1px solid var(--color-border);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  flex-shrink: 0;
}

.tabs-container::-webkit-scrollbar {
  display: none;
}

.tabs {
  display: flex;
  gap: var(--spacing-sm);
  min-width: min-content;
}

.tab {
  padding: var(--spacing-sm) var(--spacing-lg);
  background: var(--color-bg-tertiary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  color: var(--color-text-secondary);
  font-size: var(--font-size-sm);
  white-space: nowrap;
  cursor: pointer;
  transition: all 0.3s;
  user-select: none;
}

.tab.active {
  background: var(--color-bg-card);
  border-color: var(--color-border-light);
  color: var(--color-text-primary);
  font-weight: 600;
}

/* ========== ä¸»å…§å®¹å€åŸŸï¼ˆç¶ è‰²å€åŸŸï¼‰========== */
.content {
  flex: 1;
  padding: var(--spacing-md) var(--spacing-lg);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

/* ========== å·¥å…·å¡ç‰‡ ========== */
.tool-card {
  background: var(--color-bg-secondary);
  border-radius: var(--radius-lg);
  padding: var(--spacing-md);
  margin-bottom: var(--spacing-sm);
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  min-height: 80px;
  border: 1px solid var(--color-border);
}

.tool-card:active {
  transform: scale(0.98);
}

.tool-icon {
  width: 56px;
  height: 56px;
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  flex-shrink: 0;
}

.tool-content {
  flex: 1;
  min-width: 0;
}

.tool-title {
  color: var(--color-text-primary);
  font-size: var(--font-size-base);
  font-weight: 600;
  margin-bottom: var(--spacing-xs);
}

.tool-description {
  color: var(--color-text-tertiary);
  font-size: var(--font-size-xs);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.tool-arrow {
  color: var(--color-text-tertiary);
  font-size: var(--font-size-lg);
  flex-shrink: 0;
}

/* ========== åº•éƒ¨æŠ½å±œï¼ˆç´…è‰²å€åŸŸï¼‰- å…¨è¢å¹•æ¥µé™ ========== */
.bottom-sheet-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 999;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
}

.bottom-sheet-overlay.active {
  opacity: 1;
  pointer-events: auto;
}

.bottom-sheet {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--color-bg-primary);
  z-index: 1000;
  width: 100%;
  height: 100%;
  max-height: 100vh;
  display: flex;
  flex-direction: column;
  transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  touch-action: none;
}

.bottom-sheet.active {
  transform: translateY(0);
}

.bottom-sheet-handle {
  width: 40px;
  height: 4px;
  background: var(--color-border-light);
  border-radius: 2px;
  margin: var(--spacing-lg) auto;
  cursor: grab;
}

.bottom-sheet-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 var(--spacing-lg) var(--spacing-lg);
  border-bottom: 1px solid var(--color-border);
  flex-shrink: 0;
}

.bottom-sheet-title {
  color: var(--color-text-primary);
  font-size: var(--font-size-lg);
  font-weight: 600;
}

.bottom-sheet-close {
  font-size: var(--font-size-xl);
  cursor: pointer;
  color: var(--color-text-tertiary);
}

.bottom-sheet-content {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  padding: var(--spacing-lg);
  width: 100%;
}

.bottom-sheet-content iframe {
  width: 100%;
  height: 100%;
  border: none;
  border-radius: var(--radius-md);
}

/* ========== åº•éƒ¨å°èˆªï¼ˆé»ƒè‰²å€åŸŸï¼‰- ç¨ç«‹åˆ†é–‹ ========== */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--color-bg-secondary);
  border-top: 1px solid var(--color-border);
  display: flex;
  justify-content: space-around;
  padding: var(--spacing-sm) 0;
  z-index: 100;
  flex-shrink: 0;
}

.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  padding: var(--spacing-xs);
  color: var(--color-text-tertiary);
  font-size: var(--font-size-xs);
  cursor: pointer;
  transition: all 0.2s;
  user-select: none;
}

.nav-item.active {
  color: var(--color-text-primary);
}

.nav-icon {
  font-size: 22px;
}

/* ========== åˆ†é¡å…§å®¹ï¼ˆæ¨¡æ¿ç³»çµ±ï¼‰========== */
.category-section {
  display: none;
}

.category-section.active {
  display: block;
}

/* ========== åˆ†é¡é¸é …å¡ï¼ˆæ©«å‘æ¨™ç±¤ï¼‰========== */
.category-tabs {
  display: flex;
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-lg);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.category-tabs::-webkit-scrollbar {
  display: none;
}

.category-tab {
  padding: var(--spacing-sm) var(--spacing-lg);
  background: var(--color-bg-secondary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  color: var(--color-text-secondary);
  font-size: var(--font-size-sm);
  white-space: nowrap;
  cursor: pointer;
  transition: all 0.3s;
}

.category-tab.active {
  background: var(--color-bg-card);
  border-color: var(--color-border-light);
  color: var(--color-text-primary);
  font-weight: 600;
}

/* ========== é é¢å®¹å™¨ ========== */
.page-section {
  display: none;
}

.page-section.active {
  display: block;
}

/* iOS å„ªåŒ– */
@supports (-webkit-touch-callout: none) {
  body {
    min-height: -webkit-fill-available;
  }
}
</style>
</head>
<body>

<!-- é é¢å®¹å™¨ -->
<div class="page-wrapper">
  
  <!-- é ­éƒ¨ -->
  <div class="header">
    <div class="header-left" onclick="goBack()">è¿”å›</div>
    <div class="header-center">æ•´åˆå·¥å…·</div>
    <div class="header-right" onclick="toggleMenu()">â˜°</div>
  </div>

  <!-- æœç´¢æ¬„ -->
  <div class="search-container">
    <div class="search-box">
      <div style="font-size: 18px;">ğŸ”</div>
      <input type="text" class="search-input" placeholder="æœå°‹å·¥å…·" id="searchInput" oninput="handleSearch()">
    </div>
  </div>

  <!-- åˆ†é¡æ¨™ç±¤ï¼ˆè—è‰²å€åŸŸï¼‰- ä¸»å°èˆª -->
  <div class="tabs-container">
    <div class="tabs" id="mainTabs">
      <div class="tab active" onclick="switchMainTab('integrate')">æ•´åˆ</div>
      <div class="tab" onclick="switchMainTab('tattoo')">åˆºé’</div>
      <div class="tab" onclick="switchMainTab('energy')">èƒ½é‡</div>
      <div class="tab" onclick="switchMainTab('record')">ç´€éŒ„</div>
    </div>
  </div>

  <!-- ä¸»å…§å®¹å€åŸŸï¼ˆç¶ è‰²å€åŸŸï¼‰ -->
  <div class="content" id="mainContent">
    
    <!-- æ•´åˆåˆ†é¡ -->
    <div id="integratePage" class="page-section active">
      <div id="integrateGrid"></div>
    </div>

    <!-- åˆºé’åˆ†é¡ -->
    <div id="tattooPage" class="page-section">
      <!-- åˆºé’å…§éƒ¨æ¨™ç±¤ -->
      <div class="category-tabs" id="tattooTabs"></div>
      <!-- åˆºé’å…§å®¹ -->
      <div id="tattooContent"></div>
    </div>

    <!-- èƒ½é‡åˆ†é¡ -->
    <div id="energyPage" class="page-section">
      <!-- èƒ½é‡å…§éƒ¨æ¨™ç±¤ -->
      <div class="category-tabs" id="energyTabs"></div>
      <!-- èƒ½é‡å…§å®¹ -->
      <div id="energyContent"></div>
    </div>

    <!-- ç´€éŒ„åˆ†é¡ -->
    <div id="recordPage" class="page-section">
      <div id="recordContent"></div>
    </div>

  </div>

</div>

<!-- åº•éƒ¨æŠ½å±œï¼ˆç´…è‰²å€åŸŸï¼‰- å…¨è¢å¹•æ¥µé™ -->
<div class="bottom-sheet-overlay" id="bottomSheetOverlay" onclick="closeBottomSheet()"></div>
<div class="bottom-sheet" id="bottomSheet">
  <div class="bottom-sheet-handle"></div>
  <div class="bottom-sheet-header">
    <div class="bottom-sheet-title" id="sheetTitle">å·¥å…·</div>
    <div class="bottom-sheet-close" onclick="closeBottomSheet()">âœ•</div>
  </div>
  <div class="bottom-sheet-content" id="sheetContent"></div>
</div>

<!-- åº•éƒ¨å°èˆªï¼ˆé»ƒè‰²å€åŸŸï¼‰- ç¨ç«‹åˆ†é–‹ -->
<div class="bottom-nav">
  <div class="nav-item active" onclick="switchMainTab('integrate')">
    <div class="nav-icon">ğŸ“¦</div>
    <div>æ•´åˆ</div>
  </div>
  <div class="nav-item" onclick="switchMainTab('tattoo')">
    <div class="nav-icon">ğŸ–‹</div>
    <div>åˆºé’</div>
  </div>
  <div class="nav-item" onclick="switchMainTab('energy')">
    <div class="nav-icon">âš¡</div>
    <div>èƒ½é‡</div>
  </div>
  <div class="nav-item" onclick="switchMainTab('record')">
    <div class="nav-icon">ğŸ“</div>
    <div>ç´€éŒ„</div>
  </div>
</div>

<script>
// ============ å„²å­˜éµå€¼ ============
const STORAGE_KEYS = {
  TOOLS_LIST: 'integrateTool_toolsList',
  TATTOO_CATEGORIES: 'integrateTool_tattooCategories',
  ENERGY_CATEGORIES: 'integrateTool_energyCategories',
  RECORDS: 'integrateTool_records',
  CURRENT_MAIN_TAB: 'integrateTool_currentMainTab'
};

// ============ æ•´åˆåˆ†é¡å·¥å…·ï¼ˆå¯ç„¡é™å»¶çºŒï¼‰============
const DEFAULT_TOOLS = [
  {
    id: 'tool1',
    title: 'å·¥å…·1',
    description: 'apple1 åŠŸèƒ½èªªæ˜',
    icon: 'ğŸ',
    color: '#FF8A80',
    url: 'https://30ta2.github.io/ap/apple1.html'
  },
  {
    id: 'tool2',
    title: 'å·¥å…·2',
    description: 'apple2 åŠŸèƒ½èªªæ˜',
    icon: 'ğŸ',
    color: '#82B1FF',
    url: 'https://30ta2.github.io/ap/apple2.html'
  },
  {
    id: 'tool3',
    title: 'å·¥å…·3',
    description: 'è‡ªè¨‚å·¥å…·èªªæ˜',
    icon: 'ğŸ”§',
    color: '#FFD54F',
    url: ''
  },
  {
    id: 'tool4',
    title: 'å·¥å…·4',
    description: 'è‡ªè¨‚å·¥å…·èªªæ˜',
    icon: 'ğŸ“Š',
    color: '#69F0AE',
    url: ''
  },
  {
    id: 'tool5',
    title: 'å·¥å…·5',
    description: 'è‡ªè¨‚å·¥å…·èªªæ˜',
    icon: 'âš™ï¸',
    color: '#B388FF',
    url: ''
  },
  {
    id: 'tool6',
    title: 'å·¥å…·6',
    description: 'è‡ªè¨‚å·¥å…·èªªæ˜',
    icon: 'ğŸ¯',
    color: '#64B5F6',
    url: ''
  },
  {
    id: 'tool7',
    title: 'å·¥å…·7',
    description: 'è‡ªè¨‚å·¥å…·èªªæ˜',
    icon: 'ğŸ’¡',
    color: '#FF8A65',
    url: ''
  },
  {
    id: 'tool8',
    title: 'å·¥å…·8',
    description: 'è‡ªè¨‚å·¥å…·èªªæ˜',
    icon: 'ğŸš€',
    color: '#FFD740',
    url: ''
  }
];

// ============ åˆºé’åˆ†é¡æ¨¡æ¿ ============
const DEFAULT_TATTOO_CATEGORIES = [
  {
    id: 'tattoo_cat1',
    name: 'è¨ˆæ•¸å™¨',
    icon: 'ğŸ”¢',
    color: '#FF8A80',
    items: []
  },
  {
    id: 'tattoo_cat2',
    name: 'çµ±è¨ˆ',
    icon: 'ğŸ“Š',
    color: '#82B1FF',
    items: []
  }
];

// ============ èƒ½é‡åˆ†é¡æ¨¡æ¿ ============
const DEFAULT_ENERGY_CATEGORIES = [
  {
    id: 'energy_cat1',
    name: 'è¨ˆæ•¸å™¨',
    icon: 'ğŸ”¢',
    color: '#FFD54F',
    items: []
  },
  {
    id: 'energy_cat2',
    name: 'çµ±è¨ˆ',
    icon: 'ğŸ“ˆ',
    color: '#69F0AE',
    items: []
  }
];

// ============ å…¨å±€è®Šæ•¸ ============
let allTools = [];
let tattooCategories = [];
let energyCategories = [];
let currentMainTab = 'integrate';
let currentTattooTab = '';
let currentEnergyTab = '';
let sheetStartY = 0;
let sheetCurrentY = 0;

// ============ åˆå§‹åŒ– ============
function initApp() {
  loadAllData();
  renderIntegrate();
  renderTattooCategories();
  renderEnergyCategories();
  setupBottomSheetGestures();
}

function loadAllData() {
  const toolsData = localStorage.getItem(STORAGE_KEYS.TOOLS_LIST);
  allTools = toolsData ? JSON.parse(toolsData) : DEFAULT_TOOLS;
  if (!toolsData) localStorage.setItem(STORAGE_KEYS.TOOLS_LIST, JSON.stringify(allTools));

  const tattooData = localStorage.getItem(STORAGE_KEYS.TATTOO_CATEGORIES);
  tattooCategories = tattooData ? JSON.parse(tattooData) : DEFAULT_TATTOO_CATEGORIES;
  if (!tattooData) localStorage.setItem(STORAGE_KEYS.TATTOO_CATEGORIES, JSON.stringify(tattooCategories));

  const energyData = localStorage.getItem(STORAGE_KEYS.ENERGY_CATEGORIES);
  energyCategories = energyData ? JSON.parse(energyData) : DEFAULT_ENERGY_CATEGORIES;
  if (!energyData) localStorage.setItem(STORAGE_KEYS.ENERGY_CATEGORIES, JSON.stringify(energyCategories));
}

function saveAllData() {
  localStorage.setItem(STORAGE_KEYS.TOOLS_LIST, JSON.stringify(allTools));
  localStorage.setItem(STORAGE_KEYS.TATTOO_CATEGORIES, JSON.stringify(tattooCategories));
  localStorage.setItem(STORAGE_KEYS.ENERGY_CATEGORIES, JSON.stringify(energyCategories));
}

// ============ æ•´åˆåˆ†é¡æ¸²æŸ“ ============
function renderIntegrate() {
  const grid = document.getElementById('integrateGrid');
  grid.innerHTML = '';

  allTools.forEach(tool => {
    const card = document.createElement('div');
    card.className = 'tool-card';
    card.onclick = () => openTool(tool);

    const gradientColor = adjustColor(tool.color, -20);
    card.innerHTML = `
      <div class="tool-icon" style="background: linear-gradient(135deg, ${tool.color} 0%, ${gradientColor} 100%);">
        ${tool.icon}
      </div>
      <div class="tool-content">
        <div class="tool-title">${tool.title}</div>
        <div class="tool-description">${tool.description}</div>
      </div>
      <div class="tool-arrow">â€º</div>
    `;

    grid.appendChild(card);
  });
}

// ============ åˆºé’åˆ†é¡æ¨¡æ¿ç³»çµ± ============
function renderTattooCategories() {
  const tabsContainer = document.getElementById('tattooTabs');
  const contentContainer = document.getElementById('tattooContent');
  
  tabsContainer.innerHTML = '';
  contentContainer.innerHTML = '';

  tattooCategories.forEach((category, index) => {
    const tab = document.createElement('div');
    tab.className = `category-tab ${index === 0 ? 'active' : ''}`;
    tab.textContent = category.name;
    tab.onclick = () => switchTattooTab(category.id);
    tabsContainer.appendChild(tab);
  });

  if (tattooCategories.length > 0) {
    currentTattooTab = tattooCategories[0].id;
    renderTattooTabContent(currentTattooTab);
  }
}

function switchTattooTab(categoryId) {
  currentTattooTab = categoryId;
  
  document.querySelectorAll('#tattooTabs .category-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  event.target.classList.add('active');

  renderTattooTabContent(categoryId);
}

function renderTattooTabContent(categoryId) {
  const category = tattooCategories.find(c => c.id === categoryId);
  const contentContainer = document.getElementById('tattooContent');
  
  if (!category) return;

  contentContainer.innerHTML = '';

  if (category.items.length === 0) {
    contentContainer.innerHTML = `
      <div style="text-align: center; padding: 40px; color: var(--color-text-tertiary);">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“­</div>
        <p>æ­¤åˆ†é¡æš«ç„¡å…§å®¹</p>
        <p style="font-size: var(--font-size-sm); margin-top: 16px;">é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ·»åŠ </p>
      </div>
      <button onclick="addTattooItem('${categoryId}')" style="width: 100%; padding: var(--spacing-lg); background: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: var(--color-text-secondary); border-radius: var(--radius-md); cursor: pointer; margin-top: 16px;">â• æ·»åŠ æ–°é …ç›®</button>
    `;
    return;
  }

  category.items.forEach(item => {
    const itemCard = document.createElement('div');
    itemCard.className = 'tool-card';
    itemCard.style.marginBottom = 'var(--spacing-sm)';
    itemCard.onclick = () => openTool({title: item.title, url: item.url});

    itemCard.innerHTML = `
      <div style="flex: 1;">
        <div class="tool-title">${item.title || 'æœªå‘½å'}</div>
        <div class="tool-description">${item.url || 'ç„¡é€£çµ'}</div>
      </div>
      <div style="display: flex; gap: 8px;">
        <button onclick="event.stopPropagation(); editTattooItem('${categoryId}', '${item.id}')" style="background: none; border: none; color: var(--color-text-tertiary); cursor: pointer; font-size: 18px;">âœï¸</button>
        <button onclick="event.stopPropagation(); deleteTattooItem('${categoryId}', '${item.id}')" style="background: none; border: none; color: #ff6b6b; cursor: pointer; font-size: 18px;">ğŸ—‘ï¸</button>
      </div>
    `;

    contentContainer.appendChild(itemCard);
  });

  const addBtn = document.createElement('button');
  addBtn.innerHTML = 'â• æ·»åŠ æ–°é …ç›®';
  addBtn.onclick = () => addTattooItem(categoryId);
  addBtn.style.cssText = 'width: 100%; padding: var(--spacing-lg); background: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: var(--color-text-secondary); border-radius: var(--radius-md); cursor: pointer; margin-top: var(--spacing-lg);';
  
  contentContainer.appendChild(addBtn);
}

function addTattooItem(categoryId) {
  const title = prompt('è«‹è¼¸å…¥é …ç›®åç¨±:');
  if (!title) return;

  const url = prompt('è«‹è¼¸å…¥ HTML é€£çµ:');
  if (!url) return;

  const category = tattooCategories.find(c => c.id === categoryId);
  if (category) {
    category.items.push({
      id: Date.now().toString(),
      title: title,
      url: url
    });
    saveAllData();
    renderTattooTabContent(categoryId);
  }
}

function editTattooItem(categoryId, itemId) {
  const category = tattooCategories.find(c => c.id === categoryId);
  const item = category.items.find(i => i.id === itemId);
  
  if (item) {
    const newTitle = prompt('ç·¨è¼¯åç¨±:', item.title);
    if (newTitle !== null) item.title = newTitle;
    
    const newUrl = prompt('ç·¨è¼¯é€£çµ:', item.url);
    if (newUrl !== null) item.url = newUrl;
    
    saveAllData();
    renderTattooTabContent(categoryId);
  }
}

function deleteTattooItem(categoryId, itemId) {
  if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ')) {
    const category = tattooCategories.find(c => c.id === categoryId);
    if (category) {
      category.items = category.items.filter(i => i.id !== itemId);
      saveAllData();
      renderTattooTabContent(categoryId);
    }
  }
}

// ============ èƒ½é‡åˆ†é¡æ¨¡æ¿ç³»çµ± ============
function renderEnergyCategories() {
  const tabsContainer = document.getElementById('energyTabs');
  const contentContainer = document.getElementById('energyContent');
  
  tabsContainer.innerHTML = '';
  contentContainer.innerHTML = '';

  energyCategories.forEach((category, index) => {
    const tab = document.createElement('div');
    tab.className = `category-tab ${index === 0 ? 'active' : ''}`;
    tab.textContent = category.name;
    tab.onclick = () => switchEnergyTab(category.id);
    tabsContainer.appendChild(tab);
  });

  if (energyCategories.length > 0) {
    currentEnergyTab = energyCategories[0].id;
    renderEnergyTabContent(currentEnergyTab);
  }
}

function switchEnergyTab(categoryId) {
  currentEnergyTab = categoryId;
  
  document.querySelectorAll('#energyTabs .category-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  event.target.classList.add('active');

  renderEnergyTabContent(categoryId);
}

function renderEnergyTabContent(categoryId) {
  const category = energyCategories.find(c => c.id === categoryId);
  const contentContainer = document.getElementById('energyContent');
  
  if (!category) return;

  contentContainer.innerHTML = '';

  if (category.items.length === 0) {
    contentContainer.innerHTML = `
      <div style="text-align: center; padding: 40px; color: var(--color-text-tertiary);">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“­</div>
        <p>æ­¤åˆ†é¡æš«ç„¡å…§å®¹</p>
        <p style="font-size: var(--font-size-sm); margin-top: 16px;">é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ·»åŠ </p>
      </div>
      <button onclick="addEnergyItem('${categoryId}')" style="width: 100%; padding: var(--spacing-lg); background: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: var(--color-text-secondary); border-radius: var(--radius-md); cursor: pointer; margin-top: 16px;">â• æ·»åŠ æ–°é …ç›®</button>
    `;
    return;
  }

  category.items.forEach(item => {
    const itemCard = document.createElement('div');
    itemCard.className = 'tool-card';
    itemCard.style.marginBottom = 'var(--spacing-sm)';
    itemCard.onclick = () => openTool({title: item.title, url: item.url});

    itemCard.innerHTML = `
      <div style="flex: 1;">
        <div class="tool-title">${item.title || 'æœªå‘½å'}</div>
        <div class="tool-description">${item.url || 'ç„¡é€£çµ'}</div>
      </div>
      <div style="display: flex; gap: 8px;">
        <button onclick="event.stopPropagation(); editEnergyItem('${categoryId}', '${item.id}')" style="background: none; border: none; color: var(--color-text-tertiary); cursor: pointer; font-size: 18px;">âœï¸</button>
        <button onclick="event.stopPropagation(); deleteEnergyItem('${categoryId}', '${item.id}')" style="background: none; border: none; color: #ff6b6b; cursor: pointer; font-size: 18px;">ğŸ—‘ï¸</button>
      </div>
    `;

    contentContainer.appendChild(itemCard);
  });

  const addBtn = document.createElement('button');
  addBtn.innerHTML = 'â• æ·»åŠ æ–°é …ç›®';
  addBtn.onclick = () => addEnergyItem(categoryId);
  addBtn.style.cssText = 'width: 100%; padding: var(--spacing-lg); background: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: var(--color-text-secondary); border-radius: var(--radius-md); cursor: pointer; margin-top: var(--spacing-lg);';
  
  contentContainer.appendChild(addBtn);
}

function addEnergyItem(categoryId) {
  const title = prompt('è«‹è¼¸å…¥é …ç›®åç¨±:');
  if (!title) return;

  const url = prompt('è«‹è¼¸å…¥ HTML é€£çµ:');
  if (!url) return;

  const category = energyCategories.find(c => c.id === categoryId);
  if (category) {
    category.items.push({
      id: Date.now().toString(),
      title: title,
      url: url
    });
    saveAllData();
    renderEnergyTabContent(categoryId);
  }
}

function editEnergyItem(categoryId, itemId) {
  const category = energyCategories.find(c => c.id === categoryId);
  const item = category.items.find(i => i.id === itemId);
  
  if (item) {
    const newTitle = prompt('ç·¨è¼¯åç¨±:', item.title);
    if (newTitle !== null) item.title = newTitle;
    
    const newUrl = prompt('ç·¨è¼¯é€£çµ:', item.url);
    if (newUrl !== null) item.url = newUrl;
    
    saveAllData();
    renderEnergyTabContent(categoryId);
  }
}

function deleteEnergyItem(categoryId, itemId) {
  if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ')) {
    const category = energyCategories.find(c => c.id === categoryId);
    if (category) {
      category.items = category.items.filter(i => i.id !== itemId);
      saveAllData();
      renderEnergyTabContent(categoryId);
    }
  }
}

// ============ å·¥å…·æ‰“é–‹ï¼ˆBottom Sheetï¼‰ ============
function openTool(tool) {
  if (!tool.url) {
    alert(`å·¥å…· "${tool.title}" å°šæœªè¨­å®šé é¢`);
    return;
  }

  openBottomSheet(tool.title, `<iframe src="${tool.url}"></iframe>`);
}

// ============ Bottom Sheet æ§åˆ¶ ============
function openBottomSheet(title, content) {
  document.getElementById('sheetTitle').textContent = title;
  document.getElementById('sheetContent').innerHTML = content;
  document.getElementById('bottomSheet').classList.add('active');
  document.getElementById('bottomSheetOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeBottomSheet() {
  document.getElementById('bottomSheet').classList.remove('active');
  document.getElementById('bottomSheetOverlay').classList.remove('active');
  document.body.style.overflow = 'auto';
}

function setupBottomSheetGestures() {
  const sheet = document.getElementById('bottomSheet');
  const handle = document.querySelector('.bottom-sheet-handle');
  
  if (!handle) return;

  handle.addEventListener('touchstart', (e) => {
    sheetStartY = e.touches[0].clientY;
  });

  handle.addEventListener('touchmove', (e) => {
    sheetCurrentY = e.touches[0].clientY - sheetStartY;
    if (sheetCurrentY > 0) {
      sheet.style.transform = `translateY(${sheetCurrentY}px)`;
    }
  });

  handle.addEventListener('touchend', () => {
    if (sheetCurrentY > 100) {
      closeBottomSheet();
    } else {
      sheet.style.transform = 'translateY(0)';
    }
    sheetStartY = 0;
    sheetCurrentY = 0;
  });
}

// ============ é é¢åˆ‡æ› ============
function switchMainTab(tabName) {
  currentMainTab = tabName;
  localStorage.setItem(STORAGE_KEYS.CURRENT_MAIN_TAB, tabName);

  // æ›´æ–°æ¨™ç±¤æ¨£å¼
  document.querySelectorAll('.tabs .tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelectorAll('.tabs .tab').forEach(tab => {
    if ((tabName === 'integrate' && tab.textContent === 'æ•´åˆ') ||
        (tabName === 'tattoo' && tab.textContent === 'åˆºé’') ||
        (tabName === 'energy' && tab.textContent === 'èƒ½é‡') ||
        (tabName === 'record' && tab.textContent === 'ç´€éŒ„')) {
      tab.classList.add('active');
    }
  });

  // æ›´æ–°å°èˆªæ¨£å¼
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
  const navIndex = ['integrate', 'tattoo', 'energy', 'record'].indexOf(tabName);
  if (navIndex >= 0) {
    document.querySelectorAll('.nav-item')[navIndex].classList.add('active');
  }

  // é¡¯ç¤ºå°æ‡‰é é¢
  document.querySelectorAll('.page-section').forEach(page => {
    page.classList.remove('active');
  });

  switch(tabName) {
    case 'integrate':
      document.getElementById('integratePage').classList.add('active');
      break;
    case 'tattoo':
      document.getElementById('tattooPage').classList.add('active');
      break;
    case 'energy':
      document.getElementById('energyPage').classList.add('active');
      break;
    case 'record':
      document.getElementById('recordPage').classList.add('active');
      break;
  }
}

// ============ æœç´¢åŠŸèƒ½ ============
function handleSearch() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();

  if (!searchTerm) {
    renderIntegrate();
    return;
  }

  const filtered = allTools.filter(tool =>
    tool.title.toLowerCase().includes(searchTerm) ||
    tool.description.toLowerCase().includes(searchTerm)
  );

  const grid = document.getElementById('integrateGrid');
  grid.innerHTML = '';

  filtered.forEach(tool => {
    const card = document.createElement('div');
    card.className = 'tool-card';
    card.onclick = () => openTool(tool);

    const gradientColor = adjustColor(tool.color, -20);
    card.innerHTML = `
      <div class="tool-icon" style="background: linear-gradient(135deg, ${tool.color} 0%, ${gradientColor} 100%);">
        ${tool.icon}
      </div>
      <div class="tool-content">
        <div class="tool-title">${tool.title}</div>
        <div class="tool-description">${tool.description}</div>
      </div>
      <div class="tool-arrow">â€º</div>
    `;

    grid.appendChild(card);
  });
}

// ============ å·¥å…·å‡½æ•¸ ============
function adjustColor(color, amount) {
  const col = parseInt(color.slice(1), 16);
  const r = Math.max(0, Math.min(255, (col >> 16) + amount));
  const g = Math.max(0, Math.min(255, ((col >> 8) & 0xFF) + amount));
  const b = Math.max(0, Math.min(255, (col & 0xFF) + amount));
  return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
}

function goBack() {
  closeBottomSheet();
}

function toggleMenu() {
  alert('é¸å–®åŠŸèƒ½\n\nå¯åœ¨æ­¤æ·»åŠ ï¼š\n- è¨­å®š\n- å¹«åŠ©\n- é—œæ–¼');
}

// ============ åˆå§‹åŒ–æ‡‰ç”¨ ============
window.addEventListener('DOMContentLoaded', () => {
  initApp();
});
</script>

</body>
</html>